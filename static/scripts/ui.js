var attachParentButtonListeners=(()=>{let c=`click`,b=`.delete-parent`,a=`.change-parent`;detailsModal.querySelectorAll(a).forEach(a=>{a.replaceWith(a.cloneNode(!0))});detailsModal.querySelectorAll(b).forEach(a=>{a.replaceWith(a.cloneNode(!0))});detailsModal.querySelectorAll(a).forEach(a=>{a.addEventListener(c,handleChangeParent)});detailsModal.querySelectorAll(b).forEach(a=>{a.addEventListener(c,handleDeleteParent)})});var handleDeleteParent=(a=>{if(!currentPerson)return;const b=a.target.closest(`.parent`);const c=parseInt(b.dataset.parentIndex,10);currentPerson.parents.splice(c,1);updateParentsInDetailsModal()});var updateParentsInDetailsModal=(()=>{let a=`.parent-fullname`;detailsModal.querySelectorAll(`.parent`).forEach((b,c)=>{const d=currentPerson.parents[c];if(d){b.dataset.id=d;b.querySelector(a).textContent=fullName(window.wasmBindings.get_person(d))}else{b.dataset.id=``;b.querySelector(a).textContent=translate(`PERSON.RELATIONSHIP.NOTHING`)}})});var openDetailsModal=(a=>{let c=`#details-modal-image img`,d=`open`,b=`photo`;if(!a)return;detailsModal.querySelector(`.fullname`).textContent=fullName(a);if(a[b]){detailsModal.querySelector(c).src=a[b]}else{detailsModal.querySelector(c).src=`/static/images/default.png`};sidePanel.classList.remove(d);sidePanel.querySelector(`.events`).innerHTML=``;detailsModal.querySelector(`.first-name`).value=a[`firstname`];detailsModal.querySelector(`.nickname`).value=a[`nickname`];detailsModal.querySelector(`.last-name`).value=a[`lastname`];detailsModal.querySelector(`.sex`).value=a[`gender`];detailsModal.querySelector(`.country`).value=a[`country`];detailsModal.querySelector(`.jobs`).value=a[`job`];detailsModal.querySelector(`.notes`).value=a[`notes`];addEventToSource(detailsModal,a[`events`]);addSourcesToSource(detailsModal,a[`sources`]);addDocumentsToContainer(detailsModal,a[`documents`]);updateParentsInDetailsModal();updateSpousesInDetailsModal();attachParentButtonListeners();detailsModal.classList.add(d)});var createDocumentElement=(a=>{const b=document.createElement(`div`);b.classList.add(`document-item`);const c=document.createElement(`a`);c.href=a.url;c.textContent=a.name;c.target=`_blank`;c.rel=`noopener noreferrer`;b.appendChild(c);if(is_local_editable){const c=document.createElement(`button`);c.classList.add(`delete-document-button`);const d=document.createElement(`img`);d.src=`/static/images/icons/delete_24dp_FFF_FILL0_wght400_GRAD0_opsz24.svg`;c.appendChild(d);c.addEventListener(`click`,()=>{if(!currentPerson||!currentPerson.documents)return;currentPerson.documents=currentPerson.documents.filter(b=>b.url!==a.url||b.name!==a.name);b.remove()});b.appendChild(c)};return b});var handleFileUpload=(async(a,b)=>{const c=document.createElement(`input`);c.type=`file`;c.accept=a===`image`?`image/*`:`*/*`;c.style.display=`none`;c.addEventListener(`change`,async(c)=>{const d=c.target.files[0];if(!d)return;const e=new FormData();e.append(a,d);const f=`${endpoint}/upload/${a}`;try{const c=await fetch(f,{method:`POST`,body:e,headers:{...additionalHeaders}});if(!c.ok){const a=await c.json();throw new Error(`Server error: ${c.statusText} - ${a.error}`)};const g=await c.json();if(g.url){b.value=g.url;if(a===`document`){documentNameInput.value=d.name}}}catch(a){console.error(`Error during file upload:`,a);alert(`File upload failed. See console for more details.`)}});c.click()});var personClick=(a=>{let e=`photo`,c=`open`,d=0,f=`#side-panel-image img`;if(sidePanel.classList.contains(c)&&currentPerson.id==a.parentNode.dataset.id){if(currentPerson){openDetailsModal(currentPerson);detailsModal.querySelector(`#details-modal-scrolable`).scrollTop=d;sidePanel.classList.remove(c)};return};let b=window.wasmBindings.get_person(a.parentNode.dataset.id);if(b){sidePanel.querySelector(`.fullname`).textContent=fullName(b);if(b[e]){sidePanel.querySelector(f).src=b[e]}else{sidePanel.querySelector(f).src=`/static/images/default.png`};sidePanel.querySelector(`#side-panel-scrolable`).scrollTop=d;currentPerson=b;sidePanel.querySelector(`.first-name`).value=b[`firstname`];sidePanel.querySelector(`.nickname`).value=b[`nickname`];sidePanel.querySelector(`.last-name`).value=b[`lastname`];sidePanel.querySelector(`.sex`).value=b[`gender`];sidePanel.querySelector(`.country`).value=b[`country`];sidePanel.querySelector(`.jobs`).value=b[`job`];addEventToSource(sidePanel,b[`events`]);sidePanel.classList.add(c)}});var updateSpousesInDetailsModal=(()=>{let c=`FORM.DELETE`;const a=detailsModal.querySelector(`#details-spouses`);const b=detailsModal.querySelector(`#spouses`);b.innerHTML=``;if(!currentPerson||!currentPerson.spouses||currentPerson.spouses.length===0){a.style.display=`none`;return};currentPerson.spouses.forEach(d=>{const e=window.wasmBindings.get_person(d);if(!e)return;a.style.display=`block`;const f=document.createElement(`div`);f.classList.add(`spouse`);const g=document.createElement(`p`);g.classList.add(`spouse-fullname`);g.textContent=fullName(e);f.appendChild(g);if(!window.wasmBindings.has_child_together(currentPerson.id,d)&&is_local_editable){const a=document.createElement(`button`);a.classList.add(`revoke-spouse`);a.setAttribute(`data-t`,c);a.textContent=translate(c);a.addEventListener(`click`,()=>{currentPerson.spouses=currentPerson.spouses.filter(a=>a!==d);const a=document.getElementById(`person-`+ currentPerson.id);if(a){setRecenterOn(a)};updateSpousesInDetailsModal()});f.appendChild(a)};b.appendChild(f)})});var handleChangeParent=(a=>{let c=``;const b=a.target.closest(`.parent`);currentParentIndex=parseInt(b.dataset.parentIndex,10);changeParentModal.classList.add(`open`);changeParentSearchBar.value=c;changeParentSearchBar.focus();document.getElementById(`change-parent-results`).innerHTML=c});var openAddPanel=(()=>{let b=1;currentPerson=personAdd[2];openDetailsModal(currentPerson);detailsModal.querySelector(`#details-modal-scrolable`).scrollTop=0;detailsModal.classList.add(`person-add`);detailsModal.classList.add(personAdd[b]);detailsModal.querySelector(`.fullname`).textContent=`Add a person`;sidePanel.classList.remove(`open`);const a=personAdd[b];if(a===`father`||a===`mother`||a===`spouse`){linkExistingButton.style.display=`block`}else{linkExistingButton.style.display=`none`}});var closeDetailsModal=(()=>{detailsModal.classList.remove(`open`);detailsModal.classList.remove(`person-add`);[`son`,`daughter`,`father`,`mother`,`spouse`].forEach(a=>{detailsModal.classList.remove(a)});detailsModal.querySelector(`.events`).innerHTML=``;linkExistingButton.style.display=`none`});var addDocumentsToContainer=((a,b)=>{const c=a.querySelector(`.documents-list`);c.innerHTML=``;if(b&&b.length>0){b.forEach(a=>c.appendChild(createDocumentElement(a)))}});var personAdd;let currentPerson=null;let currentParentIndex=null;const sidePanel=document.getElementById(`side-panel`);const closeButton=document.getElementById(`close-button`);const detailsModal=document.getElementById(`details-modal`);const detailsCloseButton=document.getElementById(`details-close-button`);const openDetailsModalButton=document.getElementById(`open-details-modal-button`);const linkExistingModal=document.getElementById(`link-existing-modal`);const linkExistingButton=detailsModal.querySelector(`.link-existing-button`);const linkExistingCloseButton=document.getElementById(`link-existing-close-button`);const linkSearchBar=document.getElementById(`link-search-bar`);const uploadImageModal=document.getElementById(`upload-image-modal`);const sidePanelUploadButton=document.getElementById(`side-panel-upload-button`);const detailsModalUploadButton=document.getElementById(`details-modal-upload-button`);const uploadImageCloseButton=document.getElementById(`upload-image-close-button`);const imageUrlInput=document.getElementById(`image-url`);const applyUrlButton=document.getElementById(`apply-url-button`);const uploadFileButton=document.getElementById(`upload-file-button`);const uploadDocumentFileButton=document.getElementById(`upload-document-file-button`);const sidePanelImageReset=document.getElementById(`side-panel-image-reset`);const detailsModalImageReset=document.getElementById(`details-modal-image-reset`);const addDocumentModal=document.getElementById(`add-document-modal`);const addDocumentButton=detailsModal.querySelector(`.add-document-button`);const addDocumentCloseButton=document.getElementById(`add-document-close-button`);const applyDocumentButton=document.getElementById(`apply-document-button`);const documentNameInput=document.getElementById(`document-name-input`);const documentUrlInput=document.getElementById(`document-url-input`);const changeParentModal=document.getElementById(`change-parent-modal`);const changeParentCloseButton=document.getElementById(`change-parent-close-button`);const changeParentSearchBar=document.getElementById(`change-parent-search-bar`);const allPersonsModal=document.getElementById(`all-persons-modal`);const openAllPersonsModalButton=document.getElementById(`all-persons-btn`);const closeAllPersonsModalButton=document.getElementById(`close-all-persons-modal-btn`);closeButton.addEventListener(`click`,()=>{sidePanel.classList.remove(`open`)});detailsCloseButton.addEventListener(`click`,()=>{closeDetailsModal()});linkExistingCloseButton.addEventListener(`click`,()=>{linkExistingModal.classList.remove(`open`)});closeAllPersonsModalButton.addEventListener(`click`,()=>{allPersonsModal.classList.remove(`open`)});addDocumentCloseButton.addEventListener(`click`,()=>{addDocumentModal.classList.remove(`open`)});addDocumentModal.addEventListener(`click`,a=>{if(a.target===addDocumentModal)addDocumentModal.classList.remove(`open`)});uploadImageModal.addEventListener(`click`,a=>{if(a.target===uploadImageModal)uploadImageModal.classList.remove(`open`)});uploadImageCloseButton.addEventListener(`click`,()=>{uploadImageModal.classList.remove(`open`)});document.addEventListener(`keydown`,a=>{let b=`open`;if(a.key===`Escape`){if(uploadImageModal.classList.contains(b)){uploadImageModal.classList.remove(b)}else if(addDocumentModal.classList.contains(b)){addDocumentModal.classList.remove(b)}else if(linkExistingModal.classList.contains(b)){linkExistingModal.classList.remove(b)}else if(changeParentModal.classList.contains(b)){changeParentModal.classList.remove(b)}else if(detailsModal.classList.contains(b)){closeDetailsModal()}else if(allPersonsModal.classList.contains(b)){allPersonsModal.classList.remove(b)}}});detailsModal.addEventListener(`click`,a=>{if(a.target===detailsModal){closeDetailsModal()}});linkExistingModal.addEventListener(`click`,a=>{if(a.target===linkExistingModal){linkExistingModal.classList.remove(`open`)}});const openUploadModal=()=>{uploadImageModal.classList.add(`open`)};sidePanelUploadButton.addEventListener(`click`,openUploadModal);detailsModalUploadButton.addEventListener(`click`,openUploadModal);addDocumentButton.addEventListener(`click`,()=>{addDocumentModal.classList.add(`open`)});applyDocumentButton.addEventListener(`click`,()=>{let e=``;const a=documentNameInput.value.trim();const b=documentUrlInput.value.trim();if(!a||!b||!currentPerson)return;const c={name:a,url:b};if(!currentPerson.documents){currentPerson.documents=[]};currentPerson.documents.push(c);const d=detailsModal.querySelector(`.documents-list`);d.appendChild(createDocumentElement(c));addDocumentModal.classList.remove(`open`);documentNameInput.value=e;documentUrlInput.value=e});applyUrlButton.addEventListener(`click`,()=>{let c=``;if(!currentPerson)return;const a=imageUrlInput.value.trim();currentPerson.photo=a===c?null:a;const b=currentPerson.photo||`/static/images/default.png`;sidePanel.querySelector(`#side-panel-image img`).src=b;detailsModal.querySelector(`#details-modal-image img`).src=b;uploadImageModal.classList.remove(`open`);imageUrlInput.value=c});const resetImage=()=>{if(!currentPerson)return;currentPerson.photo=null;const a=`/static/images/default.png`;sidePanel.querySelector(`#side-panel-image img`).src=a;detailsModal.querySelector(`#details-modal-image img`).src=a};sidePanelImageReset.addEventListener(`click`,resetImage);detailsModalImageReset.addEventListener(`click`,resetImage);linkExistingButton.addEventListener(`click`,()=>{let a=``;linkExistingModal.classList.add(`open`);linkSearchBar.value=a;linkSearchBar.focus();document.getElementById(`link-results`).innerHTML=a});linkSearchBar.addEventListener(`input`,()=>{let d=``;const a=linkSearchBar.value;const b=document.getElementById(`link-results`);b.innerHTML=d;if(a.length<1){return};const c=window.wasmBindings.search_persons(a);c.forEach(a=>{const [c,e,f]=a;const g=document.createElement(`div`);g.classList.add(`result-item`);g.textContent=`${c} ${e?`(${e})`:d}`;g.addEventListener(`click`,()=>{let [a,b]=personAdd;if(b===`father`||b===`mother`){b=`parent`};window.wasmBindings.link_existing_person(a,b,f);closeDetailsModal();linkExistingModal.classList.remove(`open`)});b.appendChild(g)})});openDetailsModalButton.addEventListener(`click`,()=>{if(currentPerson){openDetailsModal(currentPerson);detailsModal.querySelector(`#details-modal-scrolable`).scrollTop=0;sidePanel.classList.remove(`open`)}});uploadFileButton.addEventListener(`click`,()=>{handleFileUpload(`image`,imageUrlInput)});uploadDocumentFileButton.addEventListener(`click`,()=>{handleFileUpload(`document`,documentUrlInput)});changeParentCloseButton.addEventListener(`click`,()=>{changeParentModal.classList.remove(`open`)});changeParentModal.addEventListener(`click`,a=>{if(a.target===changeParentModal){changeParentModal.classList.remove(`open`)}});changeParentSearchBar.addEventListener(`input`,()=>{let d=``;const a=changeParentSearchBar.value;const b=document.getElementById(`change-parent-results`);b.innerHTML=d;if(a.length<1){return};const c=window.wasmBindings.search_persons(a);c.forEach(a=>{const [c,e,f]=a;const g=document.createElement(`div`);g.classList.add(`result-item`);g.textContent=`${c} ${e?`(${e})`:d}`;g.addEventListener(`click`,()=>{const a=window.wasmBindings.get_person(f);if(!a||!currentPerson)return;if(currentPerson.parents.length<2){if(a.gender===`F`){currentPerson.parents.unshift(a.id)}else{currentPerson.parents.push(a.id)}}else{currentPerson.parents[currentParentIndex]=a.id};const b=document.getElementById(`person-`+ currentPerson.id);if(b){setRecenterOn(b)};updateParentsInDetailsModal();changeParentModal.classList.remove(`open`)});b.appendChild(g)})});allPersonsModal.addEventListener(`click`,a=>{if(a.target===allPersonsModal){allPersonsModal.classList.remove(`open`)}});let allPersonsGrid=null;openAllPersonsModalButton.addEventListener(`click`,()=>{let b=0,a=Promise;allPersonsModal.classList.add(`open`);if(!allPersonsGrid){allPersonsGrid=new gridjs.Grid({columns:[{id:`id`,name:`ID`,hidden:!0},{id:`fullname`,name:translate(`PERSON.FULLNAME`)},{id:`gender`,name:translate(`PERSON.SEX.SEX`),formatter:a=>a===`M`?`♂`:`♀`},{id:`life_span`,name:translate(`PERSON.LIFESPAN`)},{id:`country`,name:translate(`PERSON.COUNTRY`)},{id:`job`,name:translate(`PERSON.JOBS`)}],data:()=>new a(a=>{const b=window.wasmBindings.get_persons();a(b)}),search:!0,sort:!0,resizable:!0,pagination:{limit:15},style:{td:{"data-id":a=>a.cells[b].data}}}).render(document.getElementById(`all-persons-grid-wrapper`));allPersonsGrid.on(`rowClick`,(a,c)=>{const d=c.cells[b].data;currentPerson=window.wasmBindings.get_person(d);openDetailsModal(currentPerson)})}else{allPersonsGrid.updateConfig({data:()=>new a(a=>{const b=window.wasmBindings.get_persons();a(b)})}).forceRender()}})